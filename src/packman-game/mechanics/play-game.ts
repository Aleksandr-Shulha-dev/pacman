import { type GlobalVariablesType } from '../config/types.ts';

import { Factory } from './factory/factory.ts';
import { Game } from './game/game.ts';

// prettier-ignore
const map = [
  ['1', '-', '-', '-', '-', '-', '-', '-', '-', '-', '-', '-', '-', '2', '1', '-', '-', '-', '-', '-', '-', '-', '-', '-', '-', '-', '-', '2'],
  ['|', '.', '.', '.', '.', '.', '.', '.', '.', '.', '.', '.', '.', '|', '|', '.', '.', '.', '.', '.', '.', '.', '.', '.', '.', '.', '.', '|'],
  ['|', '.', '1', '-', '-', '2', '.', '1', '-', '-', '-', '2', '.', '|', '|', '.', '1', '-', '-', '-', '2', '.', '1', '-', '-', '2', '.', '|'],
  ['|', 'o', '|', ' ', ' ', '|', '.', '|', ' ', ' ', ' ', '|', '.', '|', '|', '.', '|', ' ', ' ', ' ', '|', '.', '|', ' ', ' ', '|', 'o', '|'],
  ['|', '.', '4', '-', '-', '3', '.', '4', '-', '-', '-', '3', '.', '4', '3', '.', '4', '-', '-', '-', '3', '.', '4', '-', '-', '3', '.', '|'],
  ['|', '.', '.', '.', '.', '.', '.', '.', '.', '.', '.', '.', '.', '.', '.', '.', '.', '.', '.', '.', '.', '.', '.', '.', '.', '.', '.', '|'],
  ['|', '.', '1', '-', '-', '2', '.', '1', '2', '.', '1', '-', '-', '-', '-', '-', '-', '2', '.', '1', '2', '.', '1', '-', '-', '2', '.', '|'],
  ['|', '.', '4', '-', '-', '3', '.', '|', '|', '.', '4', '-', '-', '2', '1', '-', '-', '3', '.', '|', '|', '.', '4', '-', '-', '3', '.', '|'],
  ['|', '.', '.', '.', '.', '.', '.', '|', '|', '.', '.', '.', '.', '|', '|', '.', '.', '.', '.', '|', '|', '.', '.', '.', '.', '.', '.', '|'],
  ['4', '-', '-', '-', '-', '2', '.', '|', '4', '-', '-', '2', ' ', '|', '|', ' ', '1', '-', '-', '3', '|', '.', '1', '-', '-', '-', '-', '3'],
  [' ', ' ', ' ', ' ', ' ', '|', '.', '|', '1', '-', '-', '3', ' ', '4', '3', ' ', '4', '-', '-', '2', '|', '.', '|', ' ', ' ', ' ', ' ', ' '],
  [' ', ' ', ' ', ' ', ' ', '|', '.', '|', '|', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', '|', '|', '.', '|', ' ', ' ', ' ', ' ', ' '],
  [' ', ' ', ' ', ' ', ' ', '|', '.', '|', '|', ' ', '1', '-', '-', '-', '-', '-', '-', '2', ' ', '|', '|', '.', '|', ' ', ' ', ' ', ' ', ' '],
  ['-', '-', '-', '-', '-', '3', '.', '4', '3', ' ', '|', ' ', ' ', ' ', ' ', ' ', ' ', '|', ' ', '4', '3', '.', '4', '-', '-', '-', '-', '-'],
  [' ', ' ', ' ', ' ', ' ', ' ', '.', ' ', ' ', ' ', '|', ' ', ' ', ' ', ' ', ' ', ' ', '|', ' ', ' ', ' ', '.', ' ', ' ', ' ', ' ', ' ', ' '],
  ['-', '-', '-', '-', '-', '2', '.', '1', '2', ' ', '|', ' ', ' ', ' ', ' ', ' ', ' ', '|', ' ', '1', '2', '.', '1', '-', '-', '-', '-', '-'],
  [' ', ' ', ' ', ' ', ' ', '|', '.', '|', '|', ' ', '4', '-', '-', '-', '-', '-', '-', '3', ' ', '|', '|', '.', '|', ' ', ' ', ' ', ' ', ' '],
  [' ', ' ', ' ', ' ', ' ', '|', '.', '|', '|', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', '|', '|', '.', '|', ' ', ' ', ' ', ' ', ' '],
  [' ', ' ', ' ', ' ', ' ', '|', '.', '|', '|', ' ', '1', '-', '-', '-', '-', '-', '-', '2', ' ', '|', '|', '.', '|', ' ', ' ', ' ', ' ', ' '],
  ['1', '-', '-', '-', '-', '3', '.', '4', '3', ' ', '4', '-', '-', '2', '1', '-', '-', '3', ' ', '4', '3', '.', '4', '-', '-', '-', '-', '2'],
  ['|', '.', '.', '.', '.', '.', '.', '.', '.', '.', '.', '.', '.', '|', '|', '.', '.', '.', '.', '.', '.', '.', '.', '.', '.', '.', '.', '|'],
  ['|', '.', '1', '-', '-', '2', '.', '1', '-', '-', '-', '2', '.', '|', '|', '.', '1', '-', '-', '-', '2', '.', '1', '-', '-', '2', '.', '|'],
  ['|', '.', '4', '-', '2', '|', '.', '4', '-', '-', '-', '3', '.', '4', '3', '.', '4', '-', '-', '-', '3', '.', '|', '1', '-', '3', '.', '|'],
  ['|', 'o', '.', '.', '|', '|', '.', '.', '.', '.', '.', '.', '.', ' ', ' ', '.', '.', '.', '.', '.', '.', '.', '|', '|', '.', '.', 'o', '|'],
  ['4', '-', '2', '.', '|', '|', '.', '1', '2', '.', '1', '-', '-', '-', '-', '-', '-', '2', '.', '1', '2', '.', '|', '|', '.', '1', '-', '3'],
  ['1', '-', '3', '.', '4', '3', '.', '|', '|', '.', '4', '-', '-', '2', '1', '-', '-', '3', '.', '|', '|', '.', '4', '3', '.', '4', '-', '2'],
  ['|', '.', '.', '.', '.', '.', '.', '|', '|', '.', '.', '.', '.', '|', '|', '.', '.', '.', '.', '|', '|', '.', '.', '.', '.', '.', '.', '|'],
  ['|', '.', '1', '-', '-', '-', '-', '3', '4', '-', '-', '2', '.', '|', '|', '.', '1', '-', '-', '3', '4', '-', '-', '-', '-', '2', '.', '|'],
  ['|', '.', '4', '-', '-', '-', '-', '-', '-', '-', '-', '3', '.', '4', '3', '.', '4', '-', '-', '-', '-', '-', '-', '-', '-', '3', '.', '|'],
  ['|', '.', '.', '.', '.', '.', '.', '.', '.', '.', '.', '.', '.', '.', '.', '.', '.', '.', '.', '.', '.', '.', '.', '.', '.', '.', '.', '|'],
  ['4', '-', '-', '-', '-', '-', '-', '-', '-', '-', '-', '-', '-', '-', '-', '-', '-', '-', '-', '-', '-', '-', '-', '-', '-', '-', '-', '3'],
];

const variables: GlobalVariablesType = {
  tileLength: 32,
  isWindowVisible: true,
  isGamePaused: false,
  score: 0,
  lastKeyPressed: '',
  level: 1,
  player: undefined,
  reactRoot: null,
  killCount: 0,
  start: true,
  animationId: null,
  directionEventListener: null,
  visibilityEventListener: null,
  pauseEventListener: null,
  levelUpCount: 0,
  frameLifetime: 10,
  startTime: 0,
};
const assets = Factory.makeAssets(map, variables, {});

function playGame(player: number | undefined, reactRoot: Element | null): void {
  variables.animationId = requestAnimationFrame(() =>
    playGame(player, reactRoot),
  );
  const board = document.querySelector('#board') as HTMLCanvasElement;
  const context = board.getContext('2d') as CanvasRenderingContext2D;

  if (variables.start === true) {
    Game.finishSetup({ variables, reactRoot, assets, context });
  }

  if (performance.now() - variables.startTime >= variables.frameLifetime) {
    context.clearRect(0, 0, board.width, board.height);
    Game.implementPhysics(assets, context, variables);
    Game.implementGraphics(variables, assets.characters.pacman);
    Game.manageGhostAudio(assets);
    variables.startTime = performance.now();
  }
}

export { assets, playGame };
